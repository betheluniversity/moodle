define(["jquery","core/log"],function(a,b){"use strict";return b.debug("Interactive Transcript: initialising"),{init:function(b){var c=b.component,d=b.playerid,e=b.containerid,f=b.cssprefix,g={};if(g.settings={},d&&a("#"+d).length){g.component=c,g.prefix=f,g.player=a("#"+d)[0],g.title=M.util.get_string("transcripttitle",c);var h=this.transcript(g);a("#"+e).append(h.el())}},defaults:{autoscroll:!0,clickArea:"line",showTitle:!0,showTrackSelector:!1,followPlayerTrack:!0,scrollToCenter:!1,stopScrollWhenInUse:!0},utils:{prefix:"transcript",secondsToTime:function(a){var b=Math.floor(a/3600),c=Math.floor(a%3600/60),d=Math.floor(a%60);return d=d<10?"0"+d:d,c=b>0&&c<10?"0"+c:c,b>0?b+":"+c+":"+d:c+":"+d},localize:function(a){return a},createEl:function(a,b){b=b||"";var c=document.createElement(a);return c.className=b,c},extend:function(a){var b=typeof a;if(!("function"===b||"object"===b&&a))return a;for(var c,d,e=1,f=arguments.length;e<f;e++){c=arguments[e];for(d in c)a[d]=c[d]}return a}},eventEmitter:{handlers_:[],on:function(a,b,c){if("function"!=typeof c)throw new TypeError("Callback is not a function.");this.handlers_.push([a,b,c])},trigger:function(a,b){this.handlers_.forEach(function(c){c[0]===a&&c[1]===b&&c[2].apply()})}},scrollerProto:function(a){var b=function(a){var b=this;a.addEventListener("scroll",function(){b.isAutoScrolling?b.isAutoScrolling=!1:(b.userIsScrolling=!0,a.classList.add("is-inuse"))}),a.addEventListener("mouseenter",function(){b.mouseIsOverTranscript=!0}),a.addEventListener("mouseleave",function(){b.mouseIsOverTranscript=!1,setTimeout(function(){b.mouseIsOverTranscript||(b.userIsScrolling=!1,a.classList.remove("is-inuse"))},1e3)})},c=function(a){return this.element=a,this.userIsScrolling=!1,this.mouseIsOverTranscript=!0,this.isAutoScrolling=!0,b.call(this,this.element),this},d=function(a,b,c,d){return b+c*Math.sin(Math.min(1,a/d)*(Math.PI/2))},e=function(a,b,c){var e=Date.now(),f=a.scrollTop,g=this;b=Math.max(0,b),b=Math.min(a.scrollHeight-a.clientHeight,b);var h=b-f,i=function(){var j=Date.now(),k=j-e;g.isAutoScrolling=!0,a.scrollTop=d(k,f,h,c),a.scrollTop!==b&&requestAnimationFrame(i,a)};requestAnimationFrame(i,a)},f=function(b){if(this.canScroll()){var c,d=b.parentElement,f=(d.offsetTop+d.clientHeight,b.offsetTop+b.clientHeight),g=b.offsetTop,h=b.offsetTop+b.clientHeight,i=0;a.settings.scrollToCenter&&(i=Math.round(d.clientHeight/2-b.clientHeight/2)),g<d.scrollTop+i?c=b.offsetTop-i:h>d.scrollTop+d.clientHeight-i&&(c=f+i),void 0!==c&&d.scrollTop!==c&&e.call(this,d,c,400)}},g=function(){var a=this.element;return a.scrollHeight>a.offsetHeight},h=function(){return this.userIsScrolling};return{init:c,to:f,canScroll:g,inUse:h}},scroller:function(a,b){return Object.create(this.scrollerProto(b)).init(a)},trackList:function(a){var b;return{get:function(){var b,c,d=[];for(a.tracks=a.player.textTracks,b=0;b<a.tracks.length;b++)c=a.tracks[b],"captions"!==c.kind&&"subtitles"!==c.kind||d.push(c);return d},active:function(c){var d,e;for(d=0;d<a.tracks.length;d++)if(e=a.tracks[d],"showing"===e.mode)return b=e,e;return b||c[0]}}},widget:function(a){var b=this,c={};c.element={},c.body={};var d=function(a,c){eventEmitter.on(b,a,c)},e=function(a){eventEmitter.trigger(b,a)},f=function(){var c=b.utils.createEl("header",a.prefix+"-header");return c.textContent=a.title,c},g=function(){var c=b.utils.createEl("select",a.prefix+"-selector");return a.validTracks.forEach(function(a,b){var d=document.createElement("option");d.value=b,d.textContent=a.label+" ("+a.language+")",c.appendChild(d)}),c.addEventListener("change",function(b){l(document.querySelector("#"+a.prefix+"-"+a.player.id+" option:checked").value),e("trackchanged")}),c},h=function(b){var c=b.target.classList,d=b.target.getAttribute("data-begin")||b.target.parentElement.getAttribute("data-begin");void 0!==d&&null!==d&&("line"===a.settings.clickArea||"timestamp"===a.settings.clickArea&&c.contains(a.prefix+"-timestamp")||"text"===a.settings.clickArea&&c.contains(a.prefix+"-text"))&&(a.player.currentTime=d)},i=function(d){var e=b.utils.createEl("div",a.prefix+"-line"),f=b.utils.createEl("span",a.prefix+"-timestamp"),g=b.utils.createEl("span",a.prefix+"-text");return e.setAttribute("data-begin",d.startTime),e.setAttribute("tabindex",c._options.tabIndex||0),f.textContent=b.utils.secondsToTime(d.startTime),g.innerHTML=d.text,e.appendChild(f),e.appendChild(g),e},j=function(d){"object"!=typeof d&&(d=a.player.textTracks()[d]);var e,f,g=b.utils.createEl("div",a.prefix+"-body"),k=document.createDocumentFragment();if(d.activeCues){var l=d.cues;for(f=0;f<l.length;f++)e=i(l[f]),k.appendChild(e);g.innerHTML="",g.appendChild(k),g.setAttribute("lang",d.language),g.scroll=b.scroller(g,a),g.addEventListener("click",h),c.element.replaceChild(g,c.body),c.body=g}else"showing"!==d.mode&&(d.mode="hidden"),window.setTimeout(function(){j(d)},100)},k=function(d){var e=document.createElement("div");if(c._options=d,c.element=e,e.setAttribute("id",a.prefix+"-"+a.player.id),a.settings.showTitle){var h=f();e.appendChild(h)}if(a.settings.showTrackSelector){var i=g();e.appendChild(i)}return c.body=b.utils.createEl("div",a.prefix+"-body"),e.appendChild(c.body),l(a.currentTrack),this},l=function(a,b){j(a,b)},m=function(b){var d,e,f,g,h=c.body.children;for(d=0;d<h.length;d++)e=h[d],f=e.getAttribute("data-begin"),g=d<h.length-1?h[d+1].getAttribute("data-begin"):a.player.duration||1/0,b>f&&b<g?e.classList.contains("is-active")||(e.classList.add("is-active"),!a.settings.autoscroll||a.settings.stopScrollWhenInUse&&c.body.scroll.inUse()||c.body.scroll.to(e)):e.classList.remove("is-active")},n=function(){return c.element};return{create:k,setTrack:l,setCue:m,el:n,on:d,trigger:e}},transcript:function(a){var b=this,c=this.defaults;this.utils.prefix="transcript",a.validTracks=this.trackList(a).get(),a.currentTrack=this.trackList(a).active(a.validTracks),a.settings=c,a.widget=this.widget(a).create(c);var d=function(){a.widget.setCue(a.player.currentTime)},e=function(){a.currentTrack=b.trackList(a).active(a.validTracks),a.widget.setTrack(a.currentTrack)};if(!(a.validTracks.length>0))throw new Error("transcript: No tracks found!");return e(),a.player.ontimeupdate=d,a.settings.followPlayerTrack&&(a.player.oncaptionstrackchange=e,a.player.onsubtitlestrackchange=e),{el:function(){return a.widget.el()},setTrack:a.widget.setTrack}}}});